// @ts-nocheck
const bcrypt=require("bcryptjs"),jwt=require("jsonwebtoken"),User=require("../models/User"),Role=require("../models/Role"),axios=require("axios"),Sport=require("../models/Sport"),{generateAccessToken:generateAccessToken,generateRefreshToken:generateRefreshToken}=require("../config/jwt"),EventList=require("../models/EventList"),mongoose=require("mongoose"),SpotRadarEvent=require("../models/SpotRadarEvent"),BetfairMarketlist=require("../models/BetfairMarketlist"),BetfairMarketOdds=require("../models/BetfairMarketOdds"),BetfairMarketResult=require("../models/MarketResult");exports.sportList=async(e,t)=>{try{const e=(await Sport.find().sort({position:1})).map((e=>{const t=e.toObject(),r=t.betfairSportList?.eventType||{},s=t.sportradarSportList||{};return t.betfair_sport_id=r.id||0,t.betfair_market_count=r.marketCount||0,t.sportradar_sport_id=s.sportId||0,t.status=s.status||"",t.minBetLimit=t.minBet,t.maxBetLimit=t.maxBet,delete t.betfairSportList,delete t.sportradarSportList,delete t.timestamp,delete t.createdAt,delete t.updatedAt,delete t.__v,delete t.minBet,delete t.maxBet,t}));return t.status(200).json({message:"All sports fetched successfully",data:e})}catch(e){return console.error("Error fetching sports:",e.message),t.status(500).json({message:"Failed to fetch sports",error:e.message})}},exports.getEvents=async(e,t)=>{try{const{fastOddsId:r}=e.params;if(!r||!mongoose.Types.ObjectId.isValid(r))return t.status(400).json({message:"Valid fastOddsId parameter is required."});const s=new mongoose.Types.ObjectId(r),a=await EventList.findOne({FastoddsId:s}).sort({timestamp:-1}),n=await SpotRadarEvent.findOne({FastoddsId:s});if(!a||!n)return t.status(404).json({message:"Event data not found for the provided FastoddsId."});const o=a.betfairEventList.events||[],i=n.spotradardeventlist||[],d=e=>{if(!e)return"";return e.toLowerCase().replace(/[@]| at | v[.]?s?[.]? | vs[.]?/gi," vs ").replace(/[^a-z0-9\s]/gi,"").split("vs").map((e=>e.trim())).sort().join(" vs ")},u=new Set,m=o.map((e=>{const t=d(e.name||"");console.log(`normalizedBetfairName: "${t}"`);let r=null;for(const s of i){const a=d(s.eventName||"");if(console.log(`🟡 Comparing:\n  Betfair: "${e.name}" → "${t}"\n  Sportradar: "${s.eventName}" → "${a}"`),t===a){console.log(`✅ Matched: "${s.eventId}" -- ${e.name}" == "${s.eventName}"`),r=s,u.add(s.eventId);break}}return{event_name:e.name,event_date:e.event_date,status:r?.status||0,betfair_event_id:e.event_id,betfair_sport_id:e.sportId,spotradarSportId:r?.sportId||0,spotradarEventId:r?.eventId||0,...e,sportradarEventDetails:r||0}})),l=i.filter((e=>!u.has(e.eventId))).map((e=>({event_name:e.eventName,event_date:new Date(e.openDate).toISOString(),status:e.status,betfair_event_id:0,betfair_sport_id:0,spotradarSportId:e.sportId,spotradarEventId:e.eventId,isFancy:"",isBM:"",isPremium:"",score:!0,tv:!1,position:1,sportradarEventDetails:e}))),c=[...m,...l];return t.status(200).json({message:"Events fetched and enriched successfully.",data:c})}catch(e){return console.error("❌ Error fetching events:",e),t.status(500).json({message:"Failed to fetch events.",error:e.message})}},exports.getBetfairMarketByEventsId=async(e,t)=>{try{const{sportId:r,eventId:s}=e.params;if(!r||!s)return t.status(400).json({status:0,message:"Missing sportId or eventId"});const a=await BetfairMarketlist.findOne({FastoddsId:r,betfair_event_id:s});return a?t.status(200).json({status:1,FastoddsId:a.FastoddsId,sportId:r,eventId:s,marketList:a.marketList}):t.status(404).json({status:0,message:"No market data found for the given sportId and eventId"})}catch(e){return console.error("Error in getBetfairMarketByEventsId:",e),t.status(500).json({success:!1,message:"Internal server error"})}},exports.getBetfairMarketOddsByEventsId=async(e,t)=>{try{const{eventId:r}=e.params;if(!r)return t.status(400).json({status:0,message:"Missing eventId"});const s=await BetfairMarketOdds.findOne({betfair_event_id:r});if(!s||!s.marketOdds||0===s.marketOdds.length)return t.status(400).json({status:0,message:"No odds found for this event"});const a=await BetfairMarketlist.findOne({betfair_event_id:r}),n={};if(a&&a.marketList)for(const e of a.marketList)n[e.marketId]={marketName:e.marketName,marketStartTime:e.marketStartTime,runnersMap:(e.runners||[]).reduce(((e,t)=>(e[t.selectionId]={runnerName:t.runnerName,sortPriority:t.sortPriority},e)),{})};const o=s.marketOdds.map((e=>{const t=n[e.marketId]||{};return{marketId:e.marketId,marketName:t.marketName||"Match Odds",marketStartTime:t.marketStartTime||null,inplay:e.inplay,status:e.status,numberOfWinners:e.numberOfWinners,numberOfRunners:e.numberOfRunners,numberOfActiveRunners:e.numberOfActiveRunners,betDelay:e.betDelay,crossMatching:e.crossMatching,complete:e.complete,isMarketDataDelayed:e.isMarketDataDelayed,runnersVoidable:e.runnersVoidable,lastMatchTime:e.lastMatchTime,totalMatched:e.totalMatched,totalAvailable:e.totalAvailable,runners:(e.runners||[]).map((e=>({selectionId:e.selectionId,runnerName:t.runnersMap?.[e.selectionId].runnerName||null,status:e.status,sortPriority:t.runnersMap?.[e.selectionId].sortPriority||null,totalMatched:e.totalMatched,availableToBack:e.ex?.availableToBack||[],availableToLay:e.ex?.availableToLay||[]})))}}));return t.status(200).json({status:1,message:"Market odds found for this event",betfair_event_id:r,marketOdds:o})}catch(e){return console.error("Error in getBetfairMarketOddsByEventsId:",e),t.status(500).json({status:0,message:"Internal server error"})}},exports.liveBetfairMarketsOddsByParams=async(e,t)=>{try{const{sportId:r,eventId:s}=e.params;if(!r||!s)return t.status(400).json({error:"sportId and eventId are required in params"});const a=await BetfairMarketlist.find({betfair_event_id:s});if(!a.length)return t.status(404).json({error:"No market records found for the given eventId"});const n=a.map((e=>e.marketList?.[0]?.marketId)).filter(Boolean);if(!n.length)return t.status(404).json({error:"No valid marketIds found in market records"});const o=n.join(",");console.log("Sending marketIds:",o);const i=await axios.post("https://exchmarket.net/exchangeapi/sports/directmarketsbook",o,{headers:{"Content-Type":"application/json"}}),d=i.data?.result||[];t.status(200).json({status:1,marketCount:n.length,result:d})}catch(e){console.error("Error fetching market odds:",e.message),t.status(500).json({error:e.message})}},exports.getBetfairMarketResultsByIds=async(e,t)=>{try{const{marketIds:r}=e.body;if(!r||"string"!=typeof r)return t.status(400).json({status:0,message:"marketIds string is required in request body"});const s=r.split(",").map((e=>e.trim())).filter((e=>e));if(0===s.length)return t.status(400).json({status:0,message:"No valid marketIds provided"});if(s.length>30)return t.status(400).json({status:0,message:"Maximum 30 marketIds are allowed per request"});const a=await BetfairMarketResult.find({marketId:{$in:s}},{_id:0,marketId:1,betfair_event_id:1,runners:1});if(!a||0===a.length)return t.status(404).json({status:0,message:"No market results found for the provided marketIds"});const n=[...new Set(a.map((e=>e.betfair_event_id)))],o=await BetfairMarketlist.find({betfair_event_id:{$in:n}}),i={};for(const e of o)if(e.marketList)for(const t of e.marketList)i[t.marketId]={marketName:t.marketName,runnersMap:(t.runners||[]).reduce(((e,t)=>(e[t.selectionId]={runnerName:t.runnerName,sortPriority:t.sortPriority},e)),{})};const d=a.map((e=>{const t=i[e.marketId]||{};return{marketId:e.marketId,betfair_event_id:e.betfair_event_id,marketName:t.marketName||null,runners:(e.runners||[]).map((e=>{const r=t.runnersMap?.[e.selectionId]||{};return{selectionId:e.selectionId,runnerName:r.runnerName||null,sortPriority:r.sortPriority||null,status:e.status,isWinner:e.isWinner}}))}}));return t.status(200).json({status:1,message:"Market results retrieved successfully",data:d})}catch(e){return console.error("Error in getBetfairMarketResultsByMarketIds:",e.message),t.status(500).json({status:0,message:"Internal server error",error:e.message})}},exports.getBetfairMarketResultsByEventId=async(e,t)=>{try{const{eventId:r}=e.params;if(!r)return t.status(400).json({status:0,message:"eventId parameter is required"});const s=await BetfairMarketResult.find({betfair_event_id:r},{_id:0,marketId:1,betfair_event_id:1,runners:1});if(!s||0===s.length)return t.status(404).json({status:0,message:"No market result found for the given eventId"});const a=await BetfairMarketlist.findOne({betfair_event_id:r}),n={};if(a&&a.marketList)for(const e of a.marketList)n[e.marketId]={marketName:e.marketName,runnersMap:(e.runners||[]).reduce(((e,t)=>(e[t.selectionId]={runnerName:t.runnerName,sortPriority:t.sortPriority},e)),{})};const o=s.map((e=>{const t=n[e.marketId]||{};return{marketId:e.marketId,marketName:t.marketName||null,runners:(e.runners||[]).map((e=>{const r=t.runnersMap?.[e.selectionId]||{};return{selectionId:e.selectionId,runnerName:r.runnerName||null,sortPriority:r.sortPriority||null,status:e.status,isWinner:e.isWinner}}))}}));return t.status(200).json({status:1,message:"Market results retrieved successfully",betfair_event_id:r,data:o})}catch(e){return console.error("Error in getBetfairMarketResultsByEventId:",e.message),t.status(500).json({status:0,message:"Internal server error",error:e.message})}};