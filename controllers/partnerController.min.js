// @ts-nocheck
const bcrypt=require("bcryptjs"),jwt=require("jsonwebtoken"),Partner=require("../models/Partner"),{generateAccessToken:generateAccessToken,generateRefreshToken:generateRefreshToken}=require("../config/jwt"),cookieOptions={httpOnly:!0,secure:!0,sameSite:"Strict"};exports.create=async(r,e)=>{try{const{partnerName:t,contactPerson:a,email:s,phone:n,websiteDomain:o,commissionPercent:i,startDate:c,endDate:d,status:u,callbackUrls:l,endpoints:p,notes:w,creatorId:m}=r.body;if(await Partner.findOne({$or:[{email:s},{phone:n},{websiteDomain:o}]}))return e.status(400).json({error:"A partner with the same email, phone, or website domain already exists."});const y=new Partner({partnerName:t,contactPerson:a,email:s,phone:n,websiteDomain:o,commissionPercent:i,startDate:new Date(c),endDate:d?new Date(d):null,status:u,callbackUrls:l,endpoints:p,notes:w,creatorId:m});await y.save(),e.status(201).json({message:"Partner created successfully",data:y})}catch(r){console.error("Error creating partner:",r),e.status(500).json({error:"Internal Server Error"})}},exports.getPartnerById=async(r,e)=>{try{const{id:t}=r.params,a=await Partner.findById(t);if(!a)return e.status(404).json({error:"Partner not found"});e.status(200).json({data:a})}catch(r){console.error("Error fetching partner by ID:",r),e.status(500).json({error:"Internal Server Error"})}},exports.getAllPartners=async(r,e)=>{try{const r=await Partner.find().sort({createdAt:-1});e.status(200).json({data:r})}catch(r){console.error("Error fetching partners:",r),e.status(500).json({error:"Internal Server Error"})}},exports.updatePartner=async(r,e)=>{try{const{id:t}=r.params,a=r.body;if(a.email||a.phone||a.websiteDomain){if(await Partner.findOne({_id:{$ne:t},$or:[{email:a.email},{phone:a.phone},{websiteDomain:a.websiteDomain}]}))return e.status(400).json({error:"Another partner with the same email, phone, or website domain already exists."})}a.startDate&&(a.startDate=new Date(a.startDate)),a.endDate&&(a.endDate=new Date(a.endDate));const s=await Partner.findByIdAndUpdate(t,a,{new:!0,runValidators:!0});if(!s)return e.status(404).json({error:"Partner not found"});e.status(200).json({message:"Partner updated successfully",data:s})}catch(r){console.error("Error updating partner:",r),e.status(500).json({error:"Internal Server Error"})}},exports.deletePartner=async(r,e)=>{try{const{id:t}=r.params;if(!await Partner.findByIdAndDelete(t))return e.status(404).json({error:"Partner not found"});e.status(200).json({message:"Partner deleted successfully"})}catch(r){console.error("Error deleting partner:",r),e.status(500).json({error:"Internal Server Error"})}},exports.setPartnerStatus=async(r,e)=>{try{const{id:t}=r.params,{status:a}=r.body;if(!["active","inactive","suspended"].includes(a))return e.status(400).json({error:"Invalid status value"});const s=await Partner.findByIdAndUpdate(t,{status:a},{new:!0});if(!s)return e.status(404).json({error:"Partner not found"});e.status(200).json({message:`Partner status updated to ${a}`,data:s})}catch(r){console.error("Error updating partner status:",r),e.status(500).json({error:"Internal Server Error"})}},exports.changePassword=async(r,e)=>{try{const{id:t}=r.params,{password:a,confirmPassword:s}=r.body;if(!a||!s)return e.status(400).json({error:"Password and confirm password are required"});if(a!==s)return e.status(400).json({error:"Passwords do not match"});const n=await Partner.findById(t);if(!n)return e.status(404).json({error:"Partner not found"});const o=await bcrypt.genSalt(10);n.password=await bcrypt.hash(a,o),await n.save(),e.status(200).json({message:"Password updated successfully"})}catch(r){console.error("Error changing password:",r),e.status(500).json({error:"Internal Server Error"})}};