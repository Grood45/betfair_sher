// @ts-nocheck
const axios=require("axios"),Marketlimit=require("../models/Marketlimit"),MarketList=require("../models/Marketlist"),ExchangeOdds=require("../models/ExchangeOdds");exports.getAllLimits=async(e,t)=>{try{const e=await Marketlimit.find().sort({marketType:1});t.status(200).json({message:"Market limits fetched successfully",data:e})}catch(e){t.status(500).json({message:"Failed to fetch market limits",error:e.message})}},exports.createOrUpdateLimit=async(e,t)=>{try{const{marketType:a,minBet:s,maxBet:r,maxProfit:n}=e.body;if(!(a&&s&&r&&n))return t.status(400).json({message:"All fields are required"});const i=await Marketlimit.findOneAndUpdate({marketType:a},{minBet:s,maxBet:r,maxProfit:n},{new:!0,upsert:!0});t.status(200).json({message:"Market limit saved successfully",data:i})}catch(e){t.status(500).json({message:"Failed to save market limit",error:e.message})}},exports.syncMarketList=async(e,t)=>{try{const{eventId:a}=e.params;if(!a)return t.status(400).json({message:"Missing eventId in query params"});const s=await axios.post("https://apidiamond.online/sports/api/market-list",{eventId:a}),r=s.data?.data;if(!Array.isArray(r))return t.status(400).json({message:"Invalid market data received"});let n=0,i=0;for(const e of r){const t=await MarketList.findOne({marketId:e.marketId});await MarketList.findOneAndUpdate({marketId:e.marketId},{$set:e},{new:!0,upsert:!0}),t?i++:n++}t.status(200).json({message:"Market sync completed",inserted:n,updated:i})}catch(e){console.error("Error syncing markets:",e.message),t.status(500).json({message:"Server error",error:e.message})}},exports.getMarketListByEventId=async(e,t)=>{try{const{eventId:a}=e.params;if(!a)return t.status(400).json({message:"Missing eventId in params"});const s=await syncMarketListByEventId(a),r=(await MarketList.find({"event.id":a},{marketId:1,_id:0})).map((e=>e.marketId)).filter(Boolean);if(0===r.length)return t.status(404).json({message:"No marketIds found after sync"});const n=await axios.get("https://apidiamond.online/sports/api/v1/macthodds/",{params:{ids:r.join(",")}}),i=n.data?.data||[];let d=0,o=0;for(const e of i){const t=await ExchangeOdds.findOne({MarketId:e.MarketId});await ExchangeOdds.findOneAndUpdate({MarketId:e.MarketId},{$set:{MarketId:e.MarketId,eventId:e.eventId,marketName:e.marketName,Status:e.Status,IsInplay:e.IsInplay,updateTime:e.updatetime,sport:e.sport,Runners:e.Runners}},{new:!0,upsert:!0}),t?o++:d++}t.status(200).json({message:"Synced, odds fetched and stored",syncSummary:s,marketIds:r,oddsStored:{inserted:d,updated:o}})}catch(e){console.error("Error fetching market list:",e.message),t.status(500).json({message:"Server error",error:e.message})}};const syncMarketListByEventId=async e=>{if(!e)throw new Error("Missing eventId");const t=await axios.post("https://apidiamond.online/sports/api/market-list",{eventId:e}),a=t.data?.data;if(!Array.isArray(a))throw new Error("Invalid market data received");let s=0,r=0;for(const e of a){const t=await MarketList.findOne({marketId:e.marketId});await MarketList.findOneAndUpdate({marketId:e.marketId},{$set:e},{new:!0,upsert:!0}),t?r++:s++}return{inserted:s,updated:r}};