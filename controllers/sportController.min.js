// @ts-nocheck
const bcrypt=require("bcryptjs"),jwt=require("jsonwebtoken"),User=require("../models/User"),Role=require("../models/Role"),axios=require("axios"),Sport=require("../models/Sport"),{generateAccessToken:generateAccessToken,generateRefreshToken:generateRefreshToken}=require("../config/jwt"),EventList=require("../models/EventList"),SpotRadarEvent=require("../models/SpotRadarEvent"),BetfairMarketlist=require("../models/BetfairMarketlist"),BetfairMarketOdds=require("../models/BetfairMarketOdds"),mongoose=require("mongoose");exports.fetchAndStoreSportradarEvents=async(t,e)=>{try{const t="ca5822fe-b4f8-4251-b72d-b3b4bfe4b133",s=await Sport.find({});for(const e of s){const s=e?.sportradarSportList?.sportId,r=e?._id;if(!s||!r)continue;let o=[];for(const e of[!0,!1]){const r=await axios.post("https://scatalog.mysportsfeed.io/api/v1/core/sr-events-count",{operatorId:"99hub",providerId:"sportsbook",partnerId:"HBPID01",isInplay:e,sportId:s,token:t}),a=r?.data?.itemsCount?.find((t=>t.sportId===s)),n=a?.total||0,i=Math.ceil(n/20);console.log(`Sport: ${s} | Inplay: ${e} | Total Events: ${n} | Pages: ${i}`);for(let r=1;r<=i;r++){const a=await axios.post("https://scatalog.mysportsfeed.io/api/v2/core/getevents",{operatorId:"99hub",providerId:"sportsbook",partnerId:"HBPID01",sportId:s,token:t,isInplay:e,pageNo:r}),n=a?.data?.sports||[];if(console.log(`Fetched ${n.length} events (inplay: ${e}) from page ${r}`),0===n.length)break;const i=n.map((t=>({...t,isInplay:e})));o.push(...i)}}await SpotRadarEvent.findOneAndUpdate({FastoddsId:r},{radarSportId:s,spotradardeventlist:o},{upsert:!0,new:!0}),console.log(`Saved ${o.length} total events for sportId ${s}`)}e.status(200).json({message:"Sportradar events (inplay & non-inplay) fetched and stored successfully."})}catch(t){console.error("Error:",t),e.status(500).json({message:"Internal server error",error:t.message})}},exports.sportList=async(t,e)=>{const s={"X-Application":"fslpapQyGZSmkZW3","X-Authentication":"ytglt106htQTwlgyxRksgBdgaMWY3OThxcPd/VSbhes=","Content-Type":"application/json"},r=[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listEventTypes",params:{filter:{}},id:1}],o={operatorId:"laser247",providerId:"SportRadar",token:"c0e509b0-6bc1-4132-80cb-71b54345af12"};try{const[t,a]=await Promise.all([axios.post("https://api.betfair.com/exchange/betting/json-rpc/v1",r,{headers:s}),axios.post("https://scatalog.mysportsfeed.io/api/v1/core/getsports",o)]),n=t.data[0]?.result||[],i=a.data?.sports||[],d={},c={};for(const t of n){d[t.eventType.name.trim().toLowerCase()]=t}for(const t of i){c[t.sportName.trim().toLowerCase()]=t}const p=new Set([...Object.keys(d),...Object.keys(c)]);let l=await Sport.findOne().sort("-position").select("position"),f=l?.position?l.position+1:1;for(const t of p){const e=t.charAt(0).toUpperCase()+t.slice(1),s=d[t]||null,r=c[t]||null,o=await Sport.findOne({sportName:new RegExp(`^${e}$`,"i")});if(o)o.betfairSportList=s,o.sportradarSportList=r,o.timestamp=new Date,o.status=1,await o.save();else{const t=new Sport({sportName:e,position:f++,betfairSportList:s?{isFound:1,message:"Sport found from Betfair",...s}:{isFound:0,message:"No sport found from Betfair"},sportradarSportList:r?{isFound:1,message:"Sport found from Sportradar",...r}:{isFound:0,message:"No sport found from Sportradar"},isBettingEnabled:!1,status:1});await t.save()}}return e.status(200).json({message:"All sports from Betfair and Sportradar synced successfully."})}catch(t){return console.error("Sync error:",t.message),e.status(500).json({message:"Failed to sync sports",error:t.response?.data||t.message})}},exports.getEventsList=async(t,e)=>{const s="https://api.betfair.com/exchange/betting/json-rpc/v1",r=require("axios");try{const t=await Sport.find({betfairSportList:{$ne:null}});for(const e of t){const t=e.betfairSportList?.eventType?.id;if(!t)continue;const o={"X-Application":"fslpapQyGZSmkZW3","X-Authentication":"ytglt106htQTwlgyxRksgBdgaMWY3OThxcPd/VSbhes=","Content-Type":"application/json"},a=[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listEvents",params:{filter:{eventTypeIds:[t],marketStartTime:{from:(new Date).toISOString()}}},id:1}];let n=[],i=0,d="No event found from Betfair";try{const t=await r.post(s,a,{headers:o});n=t.data[0]?.result||[],n.length>0&&(i=1,d="Events fetched successfully")}catch(t){console.error("Error fetching events:",t.message)}const c=[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listCompetitions",params:{filter:{eventTypeIds:[t]}},id:2}];let p={};try{const t=await r.post(s,c,{headers:o});(t.data[0]?.result||[]).forEach((t=>{p[t.competition.id]=t.competition.name}))}catch(t){console.error("Error fetching competitions:",t.message)}const l=[];for(const e of n){const a=e.event;let n=null,i=null;try{const t=[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listMarketCatalogue",params:{filter:{eventIds:[a.id],marketTypeCodes:["MATCH_ODDS"]},maxResults:"1",marketProjection:["COMPETITION"]},id:3}],e=await r.post(s,t,{headers:o}),d=e.data[0]?.result||[];if(d.length>0){n=d[0];const t=[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listMarketBook",params:{marketIds:[n.marketId],priceProjection:{priceData:["EX_BEST_OFFERS"]}},id:4}],e=await r.post(s,t,{headers:o}),a=e.data[0]?.result||[];a.length>0&&(i=a[0])}}catch(t){console.error(`Market data fetch failed for event ${a.id}:`,t.message)}let d=0;if(Array.isArray(i)){const t=i[0];d={marketId:t?.marketId||"",status:t?.status||"",totalMatched:t?.totalMatched||0,runners:Array.isArray(t.runners)?t.runners:[]}}else d="object"==typeof i&&null!==i?{marketId:i.marketId||"",status:i.status||"",totalMatched:i.totalMatched||0,runners:Array.isArray(i.runners)?i.runners:[]}:0;l.push({sportId:t||0,event_id:a.id,name:a.name,event_date:a.openDate,timezone:a.timezone||null,countryCode:a.countryCode||null,isinplay:!0===a.inPlay||new Date(a.openDate)<=new Date?"true":"false",isFancy:"",isBM:"",isPremium:"",score:!0,tv:!1,total_matched:Array.isArray(n)?n[0]?.totalMatched||0:n?.totalMatched||0,position:1,market_count:3,competition:Array.isArray(n)?n[0]?.competition||0:n?.competition||0,marketOdds:d})}const f=await EventList.findOne({sportId:e._id}),m={isFound:i,message:d,events:l};if(f)f.betfairEventList=m,f.timestamp=new Date,await f.save();else{const t=new EventList({FastoddsId:e._id,betfairEventList:m,sportradarEventList:{isFound:0,message:"Sportradar events not fetched yet",events:[]},status:1});await t.save()}}return e.status(200).json({message:"Betfair event list synced successfully for all sports."})}catch(t){return console.error("Event sync error:",t.message),e.status(500).json({message:"Failed to sync Betfair events",error:t.response?.data||t.message})}},exports.fetchAndStoreBetfairMarkets=async(t,e)=>{try{const t="fslpapQyGZSmkZW3",s="ytglt106htQTwlgyxRksgBdgaMWY3OThxcPd/VSbhes=",r=await EventList.find({});for(const e of r){const r=e.FastoddsId,o=e.betfairEventList;let a=[];if(Array.isArray(o))a=o;else{if("object"!=typeof o||null===o){console.warn(`⚠️ Skipping: Invalid betfairEventList for FastoddsId: ${r}`);continue}a=[o]}for(const e of a){const o=Array.isArray(e.events)?e.events:[];for(const e of o){const o=e?.event_id;if(o){console.log(`➡️ Processing Event ID: ${o} (FastoddsId: ${r})`);try{const e=await axios.post("https://api.betfair.com/exchange/betting/json-rpc/v1",[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listMarketCatalogue",params:{filter:{eventIds:[o]},maxResults:"100",marketProjection:["MARKET_START_TIME","RUNNER_DESCRIPTION"]},id:1}],{headers:{"X-Application":t,"X-Authentication":s,"Content-Type":"application/json"}}),a=e?.data?.[0]?.result||[];a.length>0?(await BetfairMarketlist.findOneAndUpdate({betfair_event_id:o},{$set:{FastoddsId:r,betfair_event_id:o,marketList:a}},{upsert:!0,new:!0}),console.log(`✅ Saved ${a.length} markets for event ${o}`)):console.warn(`⚠️ No market data for event ${o}`)}catch(t){console.error(`❌ API/DB error for event ${o}:`,t.message)}}}}}e.status(200).json({message:"Betfair market data stored successfully"})}catch(t){console.error("❌ Error fetching/storing betfair markets:",t),e.status(500).json({error:"Internal Server Error"})}},exports.fetchAndStoreBetfairMarketsOdds=async(t,e)=>{try{const t="fslpapQyGZSmkZW3",s="ytglt106htQTwlgyxRksgBdgaMWY3OThxcPd/VSbhes=",r=await BetfairMarketlist.find({});for(const e of r){const{FastoddsId:r,betfair_event_id:o,marketList:a}=e;if(!o||!r||!Array.isArray(a)){console.warn(`⚠️ Skipping record with missing data: ${e._id}`);continue}const n=a.map((t=>t.marketId)).filter(Boolean);if(0!==n.length){console.log(`➡️ Processing Event ID: ${o} (FastoddsId: ${r})`);try{const e=await axios.post("https://api.betfair.com/exchange/betting/json-rpc/v1",[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listMarketBook",params:{marketIds:n,priceProjection:{priceData:["EX_BEST_OFFERS"]}},id:1}],{headers:{"X-Application":t,"X-Authentication":s,"Content-Type":"application/json"}}),a=e?.data?.[0]?.result||[];a.length>0?(await BetfairMarketOdds.findOneAndUpdate({betfair_event_id:o},{$set:{_id:new mongoose.Types.ObjectId,FastoddsId:r,betfair_event_id:o,marketOdds:a}},{upsert:!0,new:!0}),console.log(`✅ Stored odds for ${a.length} markets (event ${o})`)):console.warn(`⚠️ No odds returned for event ${o}`)}catch(t){console.error(`❌ Error fetching odds for event ${o}:`,t.message)}}else console.warn(`⚠️ No valid marketIds for event ${o}`)}e.status(200).json({message:"Betfair market odds stored successfully from BetfairMarketlist"})}catch(t){console.error("❌ Error fetching/storing betfair odds:",t),e.status(500).json({error:"Internal Server Error"})}},exports.getBetfairMarketResultsByEvent=async(t,e)=>{const{eventId:s}=t.params;if(!s)return e.status(400).json({error:"eventId is required"});try{const t=await BetfairMarketlist.findOne({betfair_event_id:s});if(!t||!t.marketList||0===t.marketList.length)return e.status(404).json({message:"No markets found for given event ID"});const r=t.marketList.map((t=>t.marketId)),o=await axios.post("https://api.betfair.com/exchange/betting/json-rpc/v1",[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listMarketBook",params:{marketIds:r,priceProjection:{priceData:["EX_BEST_OFFERS"],virtualise:!0,rolloverStakes:!0}},id:1}],{headers:{"X-Application":"fslpapQyGZSmkZW3","X-Authentication":"ytglt106htQTwlgyxRksgBdgaMWY3OThxcPd/VSbhes=","Content-Type":"application/json"}});e.status(200).json({status:1,eventId:s,result:o.data})}catch(t){console.error("Error:",t.message),e.status(t.response?.status||500).json({success:!1,message:t.message,data:t.response?.data||null})}};