// @ts-nocheck
const bcrypt=require("bcryptjs"),jwt=require("jsonwebtoken"),User=require("../models/User"),Role=require("../models/Role"),axios=require("axios"),Sport=require("../models/Sport"),{generateAccessToken:generateAccessToken,generateRefreshToken:generateRefreshToken}=require("../config/jwt"),EventList=require("../models/EventList"),SpotRadarEvent=require("../models/SpotRadarEvent"),BetfairMarketlist=require("../models/BetfairMarketlist"),BetfairMarketOdds=require("../models/BetfairMarketOdds"),mongoose=require("mongoose"),BetfairMarketResult=require("../models/MarketResult");exports.fetchAndStoreSportradarEvents=async(e,t)=>{try{const e="ca5822fe-b4f8-4251-b72d-b3b4bfe4b133",s=await Sport.find({});for(const t of s){const s=t?.sportradarSportList?.sportId,r=t?._id;if(!s||!r)continue;let o=[];for(const t of[!0,!1]){const r=await axios.post("https://scatalog.mysportsfeed.io/api/v1/core/sr-events-count",{operatorId:"99hub",providerId:"sportsbook",partnerId:"HBPID01",isInplay:t,sportId:s,token:e}),a=r?.data?.itemsCount?.find((e=>e.sportId===s)),n=a?.total||0,i=Math.ceil(n/20);console.log(`Sport: ${s} | Inplay: ${t} | Total Events: ${n} | Pages: ${i}`);for(let r=1;r<=i;r++){const a=await axios.post("https://scatalog.mysportsfeed.io/api/v2/core/getevents",{operatorId:"99hub",providerId:"sportsbook",partnerId:"HBPID01",sportId:s,token:e,isInplay:t,pageNo:r}),n=a?.data?.sports||[];if(console.log(`Fetched ${n.length} events (inplay: ${t}) from page ${r}`),0===n.length)break;const i=n.map((e=>({...e,isInplay:t})));o.push(...i)}}await SpotRadarEvent.findOneAndUpdate({FastoddsId:r},{radarSportId:s,spotradardeventlist:o},{upsert:!0,new:!0}),console.log(`Saved ${o.length} total events for sportId ${s}`)}t.status(200).json({message:"Sportradar events (inplay & non-inplay) fetched and stored successfully."})}catch(e){console.error("Error:",e),t.status(500).json({message:"Internal server error",error:e.message})}},exports.sportList=async(e,t)=>{const s={"X-Application":e.betfairAppKey,"X-Authentication":e.betfairSessionToken,"Content-Type":"application/json"},r=[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listEventTypes",params:{filter:{}},id:1}],o={operatorId:"laser247",providerId:"SportRadar",token:"c0e509b0-6bc1-4132-80cb-71b54345af12"};try{const[e,a]=await Promise.all([axios.post("https://api.betfair.com/exchange/betting/json-rpc/v1",r,{headers:s}),axios.post("https://scatalog.mysportsfeed.io/api/v1/core/getsports",o)]),n=e.data[0]?.result||[],i=a.data?.sports||[],d={},c={};for(const e of n){d[e.eventType.name.trim().toLowerCase()]=e}for(const e of i){c[e.sportName.trim().toLowerCase()]=e}const p=new Set([...Object.keys(d),...Object.keys(c)]);let l=await Sport.findOne().sort("-position").select("position"),f=l?.position?l.position+1:1;for(const e of p){const t=e.charAt(0).toUpperCase()+e.slice(1),s=d[e]||null,r=c[e]||null,o=await Sport.findOne({sportName:new RegExp(`^${t}$`,"i")});if(o)o.betfairSportList=s,o.sportradarSportList=r,o.timestamp=new Date,o.status=1,await o.save();else{const e=new Sport({sportName:t,position:f++,betfairSportList:s?{isFound:1,message:"Sport found from Betfair",...s}:{isFound:0,message:"No sport found from Betfair"},sportradarSportList:r?{isFound:1,message:"Sport found from Sportradar",...r}:{isFound:0,message:"No sport found from Sportradar"},isBettingEnabled:!1,status:1});await e.save()}}return t.status(200).json({message:"All sports from Betfair and Sportradar synced successfully."})}catch(e){return console.error("Sync error:",e.message),t.status(500).json({message:"Failed to sync sports",error:e.response?.data||e.message})}},exports.getEventsList=async(e,t)=>{const s=e.betfairAppKey,r=e.betfairSessionToken,o="https://api.betfair.com/exchange/betting/json-rpc/v1",a=require("axios");try{const e=await Sport.find({betfairSportList:{$ne:null},sportName:"Tennis"});for(const t of e){const e=t.betfairSportList?.eventType?.id;if(!e)continue;const n={"X-Application":s,"X-Authentication":r,"Content-Type":"application/json"},i=[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listEvents",params:{filter:{eventTypeIds:[e],marketStartTime:{from:(new Date).toISOString()}}},id:1}];let d=[],c=0,p="No event found from Betfair";try{const e=await a.post(o,i,{headers:n});console.log("eventRes===>",e),d=e.data[0]?.result||[],d.length>0&&(c=1,p="Events fetched successfully",console.log("eventList===>",d))}catch(e){console.error("Error fetching events:",e.message)}const l=[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listCompetitions",params:{filter:{eventTypeIds:[e]}},id:2}];let f={};try{const e=await a.post(o,l,{headers:n});(e.data[0]?.result||[]).forEach((e=>{f[e.competition.id]=e.competition.name}))}catch(e){console.error("Error fetching competitions:",e.message)}const m=[];for(const t of d){const s=t.event;let r=null,i=null;try{const e=[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listMarketCatalogue",params:{filter:{eventIds:[s.id],marketTypeCodes:["MATCH_ODDS"]},maxResults:"1",marketProjection:["COMPETITION"]},id:3}],t=await a.post(o,e,{headers:n}),d=t.data[0]?.result||[];if(d.length>0){r=d[0];const e=[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listMarketBook",params:{marketIds:[r.marketId],priceProjection:{priceData:["EX_BEST_OFFERS"]}},id:4}],t=await a.post(o,e,{headers:n}),s=t.data[0]?.result||[];s.length>0&&(i=s[0])}}catch(e){console.error(`Market data fetch failed for event ${s.id}:`,e.message)}let d=0;if(Array.isArray(i)){const e=i[0];d={marketId:e?.marketId||"",status:e?.status||"",totalMatched:e?.totalMatched||0,runners:Array.isArray(e.runners)?e.runners:[]}}else d="object"==typeof i&&null!==i?{marketId:i.marketId||"",status:i.status||"",totalMatched:i.totalMatched||0,runners:Array.isArray(i.runners)?i.runners:[]}:0;m.push({sportId:e||0,event_id:s.id,name:s.name,event_date:s.openDate,timezone:s.timezone||null,countryCode:s.countryCode||null,isinplay:!0===s.inPlay||new Date(s.openDate)<=new Date?"true":"false",isFancy:"",isBM:"",isPremium:"",score:!0,tv:!1,total_matched:Array.isArray(r)?r[0]?.totalMatched||0:r?.totalMatched||0,position:1,market_count:3,competition:Array.isArray(r)?r[0]?.competition||0:r?.competition||0,marketOdds:d})}const u=await EventList.findOne({sportId:t._id}),g={isFound:c,message:p,events:m};if(u)u.betfairEventList=g,u.timestamp=new Date,await u.save();else{const e=new EventList({FastoddsId:t._id,betfairEventList:g,sportradarEventList:{isFound:0,message:"Sportradar events not fetched yet",events:[]},status:1});await e.save()}}return t.status(200).json({message:"Betfair event list synced successfully for all sports."})}catch(e){return console.error("Event sync error:",e.message),t.status(500).json({message:"Failed to sync Betfair events",error:e.response?.data||e.message})}},exports.fetchAndStoreBetfairMarkets=async(e,t)=>{try{const s=e.betfairAppKey,r=e.betfairSessionToken,o=await EventList.find({});for(const e of o){const t=e.FastoddsId,o=e.betfairEventList;let a=[];if(Array.isArray(o))a=o;else{if("object"!=typeof o||null===o){console.warn(`⚠️ Skipping: Invalid betfairEventList for FastoddsId: ${t}`);continue}a=[o]}for(const e of a){const o=Array.isArray(e.events)?e.events:[];for(const e of o){const o=e?.event_id;if(o){console.log(`➡️ Processing Event ID: ${o} (FastoddsId: ${t})`);try{const e=await axios.post("https://api.betfair.com/exchange/betting/json-rpc/v1",[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listMarketCatalogue",params:{filter:{eventIds:[o]},maxResults:"100",marketProjection:["MARKET_START_TIME","RUNNER_DESCRIPTION"]},id:1}],{headers:{"X-Application":s,"X-Authentication":r,"Content-Type":"application/json"}}),a=e?.data?.[0]?.result||[];a.length>0?(await BetfairMarketlist.findOneAndUpdate({betfair_event_id:o},{$set:{FastoddsId:t,betfair_event_id:o,marketList:a}},{upsert:!0,new:!0}),console.log(`✅ Saved ${a.length} markets for event ${o}`)):console.warn(`⚠️ No market data for event ${o}`)}catch(e){console.error(`❌ API/DB error for event ${o}:`,e.message)}}}}}t.status(200).json({message:"Betfair market data stored successfully"})}catch(e){console.error("❌ Error fetching/storing betfair markets:",e),t.status(500).json({error:"Internal Server Error"})}},exports.getBetfairMarketResultsByEvent=async(e,t)=>{const s=e.betfairAppKey,r=e.betfairSessionToken;console.log("Using AppKey:",s),console.log("Using SessionToken:",r);try{const e=await BetfairMarketlist.find({});if(!e||0===e.length)return console.log("No market records found in DB"),t.status(400).json({message:"No market records found"});const o=e.flatMap((e=>e.marketList.map((e=>e.marketId))));if(0===o.length)return console.log("No marketIds found in records"),t.status(400).json({message:"No marketIds found"});const a=((e,t)=>{const s=[];for(let r=0;r<e.length;r+=t)s.push(e.slice(r,r+t));return s})(o,30);let n=[];for(const t of a){console.log(`Fetching market book for chunk: ${t.join(",")}`);const o=await axios.post("https://api.betfair.com/exchange/betting/json-rpc/v1",[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listMarketBook",params:{marketIds:t,priceProjection:{priceData:["EX_BEST_OFFERS"],virtualise:!0,rolloverStakes:!0}},id:1}],{headers:{"X-Application":s,"X-Authentication":r,"Content-Type":"application/json"}});console.log(JSON.stringify(o.data));const a=o.data[0]?.result||[];console.log(`Received ${a.length} results from Betfair API`),n.push(...a);for(const t of a){const s=t.marketId,r=e.find((e=>e.marketList.some((e=>e.marketId===s)))),o=r?.betfair_event_id||null,a={eventId:o,betfair_event_id:o,marketId:t.marketId,marketName:t.marketName||"Match Odds",status:t.status,runners:t.runners?.map((e=>({selectionId:e.selectionId,runnerName:"",status:e.status,isWinner:"WINNER"===e.status})))};console.log(`Saving market result for marketId: ${t.marketId}, eventId: ${o}`),await BetfairMarketResult.findOneAndUpdate({marketId:t.marketId},a,{upsert:!0,new:!0})}}t.status(200).json({success:!0,message:"All market results fetched and saved",data:n})}catch(e){console.error("Error fetching/saving market results:",e.message),t.status(e.response?.status||500).json({success:!1,message:e.message,data:e.response?.data||null})}},exports.fetchAndStoreBetfairMarketsOdds=async(e,t)=>{try{const e=(await BetfairMarketlist.find({})).flatMap((e=>e.marketList.map((t=>({marketId:t.marketId,fastOddsId:e.FastoddsId,betfair_event_id:e.betfair_event_id}))))),s=60,r=[];for(let t=0;t<e.length;t+=s)r.push(e.slice(t,t+s));const o=[];for(const e of r){const t=e.map((e=>e.marketId)).join(",");console.log(`Fetching odds for: ${t}`);const s=await axios.post("https://exchmarket.net/exchangeapi/sports/directmarketsbook",JSON.stringify(t),{headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(JSON.stringify(t))}}),r=(s.data||[]).map((t=>{const s=e.find((e=>e.marketId===t.marketId));return{fastOddsId:s?.fastOddsId||null,betfair_event_id:s?.betfair_event_id||null,marketOdds:t}}));for(const e of r)await BetfairMarketOdds.findOneAndUpdate({betfair_event_id:e.betfair_event_id},{$set:{fastOddsId:e.fastOddsId},$push:{marketOdds:e.marketOdds}},{upsert:!0,new:!0}),console.log(`Saved/Updated odds for eventId: ${e.betfair_event_id}`);o.push(...r)}return t.status(200).json({status:1,message:"Odds data saved successfully.",result:o})}catch(e){return console.error("Error in fetchAndStoreBetfairMarketsOdds:",e.message),t.status(500).json({status:0,message:"Internal Server Error",error:e})}};