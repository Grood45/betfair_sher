// @ts-nocheck
const bcrypt=require("bcryptjs"),jwt=require("jsonwebtoken"),User=require("../models/User"),Role=require("../models/Role"),axios=require("axios"),Sport=require("../models/Sport"),{generateAccessToken:generateAccessToken,generateRefreshToken:generateRefreshToken}=require("../config/jwt"),EventList=require("../models/EventList");exports.sportList=async(e,t)=>{const s={"X-Application":"fslpapQyGZSmkZW3","X-Authentication":"nPScA9u3FW4UcPTzKZxuO2XQjuLyFfvVwdP7hVbwduw=","Content-Type":"application/json"},o=[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listEventTypes",params:{filter:{}},id:1}],r={operatorId:"laser247",providerId:"SportRadar",token:"c0e509b0-6bc1-4132-80cb-71b54345af12"};try{const[e,a]=await Promise.all([axios.post("https://api.betfair.com/exchange/betting/json-rpc/v1",o,{headers:s}),axios.post("https://scatalog.mysportsfeed.io/api/v1/core/getsports",r)]),n=e.data[0]?.result||[],i=a.data?.sports||[],p={},c={};for(const e of n){p[e.eventType.name.trim().toLowerCase()]=e}for(const e of i){c[e.sportName.trim().toLowerCase()]=e}const d=new Set([...Object.keys(p),...Object.keys(c)]);let l=await Sport.findOne().sort("-position").select("position"),m=l?.position?l.position+1:1;for(const e of d){const t=e.charAt(0).toUpperCase()+e.slice(1),s=p[e]||null,o=c[e]||null,r=await Sport.findOne({sportName:new RegExp(`^${t}$`,"i")});if(r)r.betfairSportList=s,r.sportradarSportList=o,r.timestamp=new Date,r.status=1,await r.save();else{const e=new Sport({sportName:t,position:m++,betfairSportList:s?{isFound:1,message:"Sport found from Betfair",...s}:{isFound:0,message:"No sport found from Betfair"},sportradarSportList:o?{isFound:1,message:"Sport found from Sportradar",...o}:{isFound:0,message:"No sport found from Sportradar"},isBettingEnabled:!1,status:1});await e.save()}}return t.status(200).json({message:"All sports from Betfair and Sportradar synced successfully."})}catch(e){return console.error("Sync error:",e.message),t.status(500).json({message:"Failed to sync sports",error:e.response?.data||e.message})}},exports.getEventsList=async(e,t)=>{const s="https://api.betfair.com/exchange/betting/json-rpc/v1",o=require("axios");try{const e=await Sport.find({betfairSportList:{$ne:null}});for(const t of e){const e=t.betfairSportList?.eventType?.id;if(!e)continue;const r={"X-Application":"fslpapQyGZSmkZW3","X-Authentication":"FGlurrRAOkMwngr4ADn3kZdEJA+g92ec8gY9ZrsoEjs=","Content-Type":"application/json"},a=[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listEvents",params:{filter:{eventTypeIds:[e],marketStartTime:{from:(new Date).toISOString()}}},id:1}];let n=[],i=0,p="No event found from Betfair";try{const e=await o.post(s,a,{headers:r});n=e.data[0]?.result||[],n.length>0&&(i=1,p="Events fetched successfully")}catch(e){console.error("Error fetching events:",e.message)}const c=[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listCompetitions",params:{filter:{eventTypeIds:[e]}},id:2}];let d={};try{const e=await o.post(s,c,{headers:r});(e.data[0]?.result||[]).forEach((e=>{d[e.competition.id]=e.competition.name}))}catch(e){console.error("Error fetching competitions:",e.message)}const l=[];for(const e of n){const t=e.event;let a=null,n=null;try{const e=[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listMarketCatalogue",params:{filter:{eventIds:[t.id],marketTypeCodes:["MATCH_ODDS"]},maxResults:"1",marketProjection:["COMPETITION"]},id:3}],i=await o.post(s,e,{headers:r}),p=i.data[0]?.result||[];if(p.length>0){a=p[0];const e=[{jsonrpc:"2.0",method:"SportsAPING/v1.0/listMarketBook",params:{marketIds:[a.marketId],priceProjection:{priceData:["EX_BEST_OFFERS"]}},id:4}],t=await o.post(s,e,{headers:r}),i=t.data[0]?.result||[];i.length>0&&(n=i[0])}}catch(e){console.error(`Market data fetch failed for event ${t.id}:`,e.message)}l.push({id:t.id,name:t.name,openDate:t.openDate,competition:a.competition,marketOdds:n})}const m=await EventList.findOne({sportId:t._id}),f={isFound:i,message:p,events:l};if(m)m.betfairEventList=f,m.timestamp=new Date,await m.save();else{const e=new EventList({FastoddsId:t._id,betfairEventList:f,sportradarEventList:{isFound:0,message:"Sportradar events not fetched yet",result:[]},status:1});await e.save()}}return t.status(200).json({message:"Betfair event list synced successfully for all sports."})}catch(e){return console.error("Event sync error:",e.message),t.status(500).json({message:"Failed to sync Betfair events",error:e.response?.data||e.message})}};