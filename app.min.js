// @ts-nocheck
const dotenv=require("dotenv");dotenv.config();const express=require("express"),app=express(),cookieParser=require("cookie-parser"),path=require("path"),cors=require("cors"),bodyParser=require("body-parser"),urlService=require("./config/utils/asyncurl.min"),port=process.env.PORT||3e3,routes=require("./routes/routeWrapper"),fs=require("fs");app.set("trust proxy",!0);const axios=require("axios"),connectDB=require("./config/db/mongoDB");connectDB();const uploadDir=path.join(__dirname,"./","uploads","icons");console.log(uploadDir),fs.existsSync(uploadDir)||fs.mkdirSync(uploadDir,{recursive:!0}),app.use(cookieParser()),app.use("/uploads/icons",express.static("uploads/icons")),app.use(bodyParser.json()),app.use(bodyParser.urlencoded({extended:!0})),app.set("view engine","ejs"),app.set("views",path.join(__dirname,"views")),app.use(express.json()),app.use(express.urlencoded({extended:!0}));const allowedOrigins=["https://sportmaindashboard.netlify.app","https://sportuserwebsite.netlify.app","https://sportbackoffice.netlify.app","http://localhost:5173"];app.use(cors({origin:function(e,s){return e?allowedOrigins.includes(e)?s(null,!0):s(new Error("Not allowed by CORS")):s(null,!0)},credentials:!0})),app.get("/",((e,s)=>{s.send("Hello, Welcome to my Node.js app running on VPS!")})),app.post("/api/proxy-sports",(async(e,s)=>{try{const{type:r,sportId:t,eventId:o,marketId:a}=e.body;let p="",i="get",n=null;switch(r){case"sport-list":p="https://apidiamond.online/sports/api/v2/api/sport-list",i="post",n={};break;case"exchange":p="https://apidiamond.online/sports/api/market-list",i="post",n={eventId:o};break;case"fancy":if(!o)return s.status(400).json({error:"eventId is required for fancy"});p=`https://apidiamond.online/sports/api/v1/bm_fancy/${o}/1`;break;case"oddBymarketId":if(!a)return s.status(400).json({error:"marketId is required for odds"});p=`https://apidiamond.online/sports/api/v1/macthodds/?ids=${a}`;break;case"premium":p="https://apidiamond.online/sports/api/v1/feed/betfair-market-in-sr",i="post",n={eventId:o,sportId:t};break;case"premium":p="https://apidiamond.online/sports/api/v2/result-sport-data",i="post",n={eventId:o};break;case"listGames":if(!t)return s.status(400).json({error:"sportId is required for listGames"});p=`https://apidiamond.online/sports/api/v1/listGames/${t}/1`;break;case"inplay":if(!t)return s.status(400).json({error:"sportId is required for inplay"});p=`https://apidiamond.online/sports/api/final-sport-list/${t}/true`;break;case"byeventid":if(!t)return s.status(400).json({error:"sportId is required for events"});p=`https://apidiamond.online/sports/api/final-event-sport-list/${t}`;break;case"upcoming":if(!t)return s.status(400).json({error:"sportId is required for upcoming"});p=`https://apidiamond.online/sports/api/final-sport-list/${t}/false`;break;case"eventsBySport":if(!t)return s.status(400).json({error:"sportId is required for eventsBySport"});p=`https://apidiamond.online/sports/api/final-event-sport-list/${t}`;break;default:return s.status(400).json({error:"Invalid type parameter"})}const u=await axios({url:p,method:i,data:n});s.status(200).json(u.data)}catch(e){console.error("Proxy API error:",e.message),s.status(500).json({message:"Proxy fetch failed",error:e.message})}})),app.use("/",routes.authRoute),app.use("/api/dashboard",routes.dashboardRoute),app.use("/api",routes.workerRoute),app.use("/api/partner",routes.partnerRoute),app.use("/api/score",routes.scoreApiRoute),app.use("/api/sport",routes.sportRoute),app.use("/api/matches",routes.matchRoute),app.use("/api/market",routes.marketRoute),app.use("/api/website",routes.websiteRoute),app.use(((e,s,r)=>{const t=new Error("Not Found");t.status=404,r(t)})),app.use(((e,s,r,t)=>{r.status(e.status||500).json({error:{message:e.message}})})),app.listen(port,"0.0.0.0",(()=>{console.log(`Server running on port ${port}`),urlService(port)}));